<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sendly — Private File Sharing</title>
<link rel="icon" href="logo.png" type="image/png" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Inter,system-ui,sans-serif;
  background:radial-gradient(circle at top,#1a1a1a,#0a0a0a 70%);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px
}
input[type=file]{display:none}

.container{
  background:#fff;
  max-width:520px;
  width:100%;
  border-radius:22px;
  padding:44px;
  box-shadow:0 25px 70px rgba(0,0,0,.45)
}

h1{text-align:center;font-size:30px}
.subtitle{text-align:center;color:#6b7280;font-size:14px;margin-bottom:32px}

.drop-zone{
  border:1.5px dashed #d1d5db;
  border-radius:16px;
  padding:52px 24px;
  text-align:center;
  cursor:pointer;
  background:#f9fafb
}
.drop-zone.dragover{background:#e5e7eb;border-color:#000}

.file-info{display:none;margin-top:24px}
.file-info.active{display:block}

.share-code{
  font-family:monospace;
  font-size:26px;
  letter-spacing:8px;
  text-align:center;
  padding:16px;
  background:#000;
  color:#fff;
  border-radius:14px;
  margin:12px 0
}

.btn{
  width:100%;
  background:#000;
  color:#fff;
  border:none;
  border-radius:14px;
  padding:14px;
  font-weight:600;
  cursor:pointer
}

.or-divider{
  display:flex;
  align-items:center;
  gap:12px;
  font-size:11px;
  color:#9ca3af;
  margin:32px 0
}
.or-divider::before,.or-divider::after{
  content:"";flex:1;height:1px;background:#e5e7eb
}

.input-section{
  background:#f9fafb;
  border:1px solid #e5e7eb;
  border-radius:16px;
  padding:20px
}

.code-input{
  width:100%;
  padding:14px;
  font-size:22px;
  text-align:center;
  letter-spacing:6px;
  border-radius:14px;
  border:1.5px solid #d1d5db;
  margin-bottom:12px;
  font-family:monospace
}

.status{margin-top:16px;font-size:13px}
</style>
</head>

<body>
<div class="container">
  <h1>Sendly</h1>
  <p class="subtitle">Private peer-to-peer file sharing</p>

  <div class="drop-zone" id="dropZone">Drop a file to share</div>
  <input type="file" id="fileInput">

  <div class="file-info" id="fileInfo">
    <div class="share-code" id="shareCode">------</div>
    <button class="btn" id="copyBtn">Copy Code</button>
  </div>

  <div class="or-divider">OR</div>

  <div class="input-section">
    <input class="code-input" id="codeInput" placeholder="XXXXXX" maxlength="6">
    <button class="btn" id="connectBtn">Connect</button>
  </div>

  <div class="status" id="status"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDm6YJ19Pnh718AjjIN32KxltRo6qpgqtM",
  authDomain: "sendly-83909.firebaseapp.com",
  databaseURL: "https://sendly-83909-default-rtdb.firebaseio.com",
  projectId: "sendly-83909"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const fileInfo = document.getElementById("fileInfo");
const shareCode = document.getElementById("shareCode");
const copyBtn = document.getElementById("copyBtn");
const codeInput = document.getElementById("codeInput");
const connectBtn = document.getElementById("connectBtn");
const status = document.getElementById("status");

let pc, channel, file;

const rtcConfig = {
  iceServers:[{urls:"stun:stun.l.google.com:19302"}]
};

const genCode = () =>
  Math.random().toString(36).substring(2,8).toUpperCase();

function log(msg){ status.textContent = msg }

dropZone.onclick = () => fileInput.click();

fileInput.onchange = async e => {
  file = e.target.files[0];
  if(!file) return;

  const code = genCode();
  shareCode.textContent = code;
  fileInfo.classList.add("active");
  log("Waiting for receiver…");

  pc = new RTCPeerConnection(rtcConfig);
  channel = pc.createDataChannel("file");

  channel.onopen = async () => {
    log("Sending file…");
    channel.send(file.name);
    channel.send(await file.arrayBuffer());
    log("File sent ✓");
  };

  pc.onicecandidate = e=>{
    if(e.candidate)
      set(ref(db,`ice/${code}/sender`),e.candidate.toJSON());
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await set(ref(db,`offers/${code}`),{sdp:offer.sdp});

  onChildAdded(ref(db,`answers/${code}`), async snap=>{
    await pc.setRemoteDescription({type:"answer",sdp:snap.val().sdp});
    remove(ref(db,`answers/${code}`));
  });
};

connectBtn.onclick = async () => {
  const code = codeInput.value.trim().toUpperCase();
  if(code.length!==6) return log("Invalid code");

  const snap = await get(ref(db,`offers/${code}`));
  if(!snap.exists()) return log("Code not found");

  pc = new RTCPeerConnection(rtcConfig);

  pc.ondatachannel = e=>{
    channel = e.channel;
    channel.onmessage = msg=>{
      if(typeof msg.data === "string") {
        file = { name: msg.data, chunks: [] };
      } else {
        const blob = new Blob([msg.data]);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = file.name;
        a.click();
        log("Download complete ✓");
      }
    };
  };

  pc.onicecandidate = e=>{
    if(e.candidate)
      set(ref(db,`ice/${code}/receiver`),e.candidate.toJSON());
  };

  await pc.setRemoteDescription({type:"offer",sdp:snap.val().sdp});
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await set(ref(db,`answers/${code}`),{sdp:answer.sdp});
};

copyBtn.onclick = () =>
  navigator.clipboard.writeText(shareCode.textContent);
</script>
</body>
</html>

