<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sendly | Send Files</title>
<style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    @media (max-width: 600px) {
      .container {
        padding: 25px;
        border-radius: 15px;
        max-width: 100%;
      }
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
      text-align: center;
      line-height: 1.5;
    }
    
    @media (max-width: 600px) {
      h1 {
        font-size: 24px;
      }
      
      .subtitle {
        font-size: 13px;
      }
    }

    .drop-zone {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 60px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9ff;
    }

    .drop-zone:hover {
      border-color: #764ba2;
      background: #f0f2ff;
    }

    .drop-zone.dragover {
      border-color: #764ba2;
      background: #e8ebff;
      transform: scale(1.02);
    }

    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .drop-zone-text {
      color: #667eea;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .drop-zone-hint {
      color: #999;
      font-size: 14px;
    }

    .file-input {
      display: none;
    }

    .file-info {
      background: #f8f9ff;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .file-info.active {
      display: block;
    }

    .file-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      word-break: break-all;
    }

    .file-size {
      color: #666;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .share-code {
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      padding: 20px;
      font-size: 32px;
      text-align: center;
      margin-bottom: 10px;
      color: #667eea;
      font-family: 'Courier New', monospace;
      font-weight: 700;
      letter-spacing: 8px;
    }
    
    @media (max-width: 600px) {
      .share-code {
        font-size: 24px;
        letter-spacing: 4px;
        padding: 15px;
      }
    }

    .code-label {
      text-align: center;
      font-size: 13px;
      color: #999;
      margin-bottom: 15px;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      width: 100%;
      margin-top: 10px;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    .status.active {
      display: block;
    }

    .status.info {
      background: #e3f2fd;
      color: #1976d2;
    }

    .status.success {
      background: #e8f5e9;
      color: #388e3c;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 15px;
      display: none;
    }

    .progress-bar.active {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.2s;
    }

    .peer-info {
      color: #666;
      font-size: 13px;
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
    }

    .connection-status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ffa726;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }

    .connection-status.connected {
      background: #66bb6a;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .stat {
      text-align: center;
      flex: 1;
      min-width: 80px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      text-transform: uppercase;
    }
    
    @media (max-width: 600px) {
      .stat-value {
        font-size: 16px;
      }
      
      .stat-label {
        font-size: 10px;
      }
    }

    .mode-badge {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 10px;
    }

    .input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9ff;
      border-radius: 10px;
    }

    .input-label {
      font-size: 14px;
      color: #667eea;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .code-input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      text-align: center;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      letter-spacing: 6px;
      text-transform: uppercase;
      outline: none;
    }

    .code-input:focus {
      border-color: #764ba2;
      box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
    }
    
    @media (max-width: 600px) {
      .code-input {
        font-size: 20px;
        letter-spacing: 4px;
        padding: 12px;
      }
    }

    .or-divider {
      text-align: center;
      margin: 20px 0;
      color: #999;
      font-size: 14px;
    }
</style>
</head>
<body>
<div class="container">
  <div style="text-align: center;">
    <h1>Sendly</h1>
    <p class="subtitle">Share files between any devices.</p>
  </div>

  <div class="drop-zone" id="dropZone">
    <div class="drop-zone-icon">ðŸ“¤</div>
    <div class="drop-zone-text">Drop a file here or click to select</div>
    <div class="drop-zone-hint">Works on any device â€¢ No size limit â€¢ Ultra-fast</div>
  </div>

  <input type="file" id="fileInput" class="file-input">

  <div class="file-info" id="fileInfo">
    <div class="file-name" id="fileName"></div>
    <div class="file-size" id="fileSize"></div>

    <div class="share-code" id="shareCode">------</div>
    <div class="code-label">Share this code with the receiver</div>

    <button class="btn" id="copyBtn">ðŸ“‹ Copy Code</button>

    <div class="peer-info" id="peerInfo">
      <span class="connection-status" id="connectionStatus"></span>
      <span id="statusText">Waiting for peer to connect...</span>
    </div>
  </div>

  <div class="or-divider" id="orDivider">OR</div>

  <div class="input-section" id="inputSection">
    <div class="input-label">Enter transfer code to receive file:</div>
    <input type="text" id="codeInput" class="code-input" placeholder="XXXXXX" maxlength="6">
    <button class="btn" id="connectBtn">ðŸ”— Connect & Download</button>
  </div>

  <div class="status" id="status"></div>

  <div class="progress-bar" id="progressBar">
    <div class="progress-fill" id="progressFill"></div>
  </div>

  <div class="stats" id="stats" style="display: none;">
    <div class="stat">
      <div class="stat-value" id="progressPercent">0%</div>
      <div class="stat-label">Progress</div>
    </div>
  </div>
</div>

<script type="module">
import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyDm6YJ19Pnh718AjjIN32KxltRo6qpgqtM",
    authDomain: "sendly-83909.firebaseapp.com",
    databaseURL: "https://sendly-83909-default-rtdb.firebaseio.com",
    projectId: "sendly-83909",
    storageBucket: "sendly-83909.firebasestorage.app",
    messagingSenderId: "1075199067786",
    appId: "1:1075199067786:web:55163b960bd5c26f6d4f73",
    measurementId: "G-LENJ8MKEW5"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const db = getDatabase(app);

const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const shareCode = document.getElementById("shareCode");
const connectBtn = document.getElementById("connectBtn");
const codeInput = document.getElementById("codeInput");
const fileInfo = document.getElementById("fileInfo");
const progressBar = document.getElementById("progressBar");
const progressFill = document.getElementById("progressFill");
const stats = document.getElementById("stats");
const progressPercent = document.getElementById("progressPercent");

dropZone.addEventListener("click", () => fileInput.click());
dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  if (e.dataTransfer.files.length) createOffer(e.dataTransfer.files[0]);
});

let pc, dc;
let file, received = [];
const CHUNK = 256 * 1024;
const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function code() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }

async function sendSignal(path, data) { await set(ref(db, path), { data, t: Date.now() }); }
async function getSignal(path) { const snap = await get(ref(db, path)); return snap.exists() ? snap.val().data : null; }
async function clearSignal(path) { await remove(ref(db, path)); }

// ---------- SENDER ----------
async function createOffer(selectedFile) {
  file = selectedFile;
  fileInfo.classList.add("active");
  fileInfo.querySelector("#fileName").textContent = file.name;
  fileInfo.querySelector("#fileSize").textContent = (file.size/1024/1024).toFixed(2)+" MB";
  
  const transferCode = code();
  shareCode.textContent = transferCode;

  pc = new RTCPeerConnection(iceConfig);
  dc = pc.createDataChannel("file");
  dc.onopen = sendFile;

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await sendSignal(`offers/${transferCode}`, { sdp: offer.sdp, name: file.name, size: file.size, type: file.type });

  onValue(ref(db, `answers/${transferCode}`), async snap => {
    if (!snap.exists()) return;
    const ans = snap.val().data;
    await pc.setRemoteDescription({ type: "answer", sdp: ans.sdp });
    await clearSignal(`answers/${transferCode}`);
  });
}

function sendFile() {
  let offset = 0;
  progressBar.classList.add("active");
  stats.style.display = "flex";

  dc.bufferedAmountLowThreshold = CHUNK * 4;

  const reader = async () => {
    if (offset < file.size) {
      const slice = file.slice(offset, offset + CHUNK);
      dc.send(await slice.arrayBuffer());
      offset += CHUNK;

      const percent = Math.floor((offset/file.size)*100);
      progressFill.style.width = percent+"%";
      progressPercent.textContent = percent+"%";

      if (dc.bufferedAmount > dc.bufferedAmountLowThreshold) {
        dc.onbufferedamountlow = reader;
      } else {
        reader();
      }
    }
  };
  reader();
}

// ---------- RECEIVER ----------
async function createAnswer(transferCode) {
  const offer = await getSignal(`offers/${transferCode}`);
  if (!offer) { alert("Invalid code"); return; }

  pc = new RTCPeerConnection(iceConfig);
  received = [];
  progressBar.classList.add("active");
  stats.style.display = "flex";

  pc.ondatachannel = e => {
    dc = e.channel;
    dc.onmessage = ev => {
      received.push(ev.data instanceof ArrayBuffer ? ev.data : ev.data.buffer);
      const receivedSize = received.reduce((a,b)=>a+b.byteLength,0);

      const percent = Math.floor((receivedSize/offer.size)*100);
      progressFill.style.width = percent+"%";
      progressPercent.textContent = percent+"%";

      if (receivedSize >= offer.size) {
        const blob = new Blob(received, { type: offer.type });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = offer.name;
        a.click();
        received = [];
        progressFill.style.width = "100%";
        progressPercent.textContent = "100%";
      }
    };
  };

  await pc.setRemoteDescription({ type: "offer", sdp: offer.sdp });
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  await sendSignal(`answers/${transferCode}`, { sdp: answer.sdp });
}

// ---------- UI ----------
fileInput.onchange = e => createOffer(e.target.files[0]);
connectBtn.onclick = () => createAnswer(codeInput.value.trim().toUpperCase());
</script>
</body>
</html>
